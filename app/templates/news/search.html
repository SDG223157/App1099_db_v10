{% extends "base.html" %}

{% block title %}News Search{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4 max-w-lg">
    <div class="bg-white rounded-lg shadow-md p-4">
        <form id="searchForm" class="mb-6">
            <div class="flex flex-col gap-3">
                <input type="text" 
                       name="symbol" 
                       id="symbol" 
                       value="{{ search_params.get('symbol') or '' }}"
                       placeholder="Enter stock symbol (e.g. AAPL)"
                       class="w-full h-12 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-base px-4">
                
                <button type="submit" 
                        id="searchButton"
                        class="w-full h-12 rounded-lg shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Search
                </button>
            </div>
        </form>

        <div id="searchResults" class="space-y-6">
            {% if articles %}
                {% for article in articles %}
                <div class="border-b border-gray-200 pb-6 last:border-b-0">
                    <div class="space-y-2">
                        <h3 class="text-lg font-medium text-gray-900">
                            <a href="{{ article.url }}" 
                               target="_blank" 
                               class="text-blue-600 hover:text-blue-800 block">
                                {{ article.title }}
                            </a>
                        </h3>
                        <span class="text-sm text-gray-500 block">{{ article.published_at }}</span>
                    </div>

                    <div class="my-3">
                        <p class="text-gray-600 text-base leading-relaxed">
                            {% if article.summary.key_points %}
                                {{ article.summary.key_points }}
                            {% endif %}
                        </p>
                    </div>

                    <div class="flex flex-wrap gap-2">
                        {% for symbol in article.symbols %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                            {{ symbol.symbol }}
                        </span>
                        {% endfor %}

                        {% if article.sentiment.explanation %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                            {% if article.sentiment.label == 'POSITIVE' %}bg-green-100 text-green-800
                            {% elif article.sentiment.label == 'NEGATIVE' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ article.sentiment.explanation }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-6 text-gray-500 text-base">
                    Enter a stock symbol to search for news articles
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const symbolInput = document.getElementById('symbol');
        const searchForm = document.getElementById('searchForm');

        if (symbolInput) {
            symbolInput.addEventListener('dblclick', function() {
                if (this.value) {
                    this.value = '';
                    this.focus();
                }
            });

            symbolInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchForm.dispatchEvent(new Event('submit'));
                }
            });
        }

        if (searchForm) {
            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const symbol = symbolInput.value.trim();
                if (!symbol) {
                    alert('Please enter a stock symbol');
                    return;
                }

                try {
                    const response = await fetch('/news/api/fetch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            symbols: [symbol],
                            limit: 10
                        })
                    });

                    if (!response.ok) throw new Error('Failed to fetch news');

                    const data = await response.json();
                    updateUI(data);

                } catch (error) {
                    console.error('Fetch error:', error);
                    alert('Failed to fetch news: ' + error.message);
                }
            });
        }

        function updateUI(data) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!data.articles || data.articles.length === 0) {
                resultsDiv.innerHTML = '<div class="text-center py-6 text-gray-500 text-base">No articles found.</div>';
                return;
            }

            resultsDiv.innerHTML = data.articles.map(article => {
                const sentimentLabel = article.sentiment_label || 'NEUTRAL';
                const sentimentExplanation = article.sentiment_explanation || 'No explanation available';
                const sentimentScore = article.sentiment_score || 0;
                const sentimentPercentage = (sentimentScore * 100).toFixed(1);

                return `
                    <div class="border-b border-gray-200 pb-6 last:border-b-0">
                        <div class="space-y-2">
                            <h3 class="text-lg font-medium text-gray-900">
                                <a href="${article.url}" target="_blank" class="text-blue-600 hover:text-blue-800 block">
                                    ${article.title}
                                </a>
                            </h3>
                            <p class="text-gray-600 text-base leading-relaxed">${article.brief_summary || ''}</p>
                        </div>
                        <div class="mt-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                                ${sentimentLabel === 'POSITIVE' ? 'bg-green-100 text-green-800' :
                                  sentimentLabel === 'NEGATIVE' ? 'bg-red-100 text-red-800' :
                                  'bg-gray-100 text-gray-800'}">
                                ${sentimentExplanation} (${sentimentPercentage}%)
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
    });
</script>
{% endblock %}